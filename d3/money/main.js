(function(_, d3) {
var chartOptions = {
	width: 900,
	height: 300,
	barWidth: 900 / 31 - 5,
	barsSpace: 5,
	startMonth: 0,
	endMonth: 11
};

var courses = [{'date':'2014-01-03','bid':'8.2100','ask':'8.2250','vol':'1265.50'},{'date':'2014-01-08','bid':'8.2300','ask':'8.2350','vol':'1153.50'},{'date':'2014-01-09','bid':'8.2570','ask':'8.2670','vol':'849.90'},{'date':'2014-01-10','bid':'8.2830','ask':'8.2880','vol':'1074.80'},{'date':'2014-01-11','bid':'8.2800','ask':'8.2900','vol':'102.00'},{'date':'2014-01-13','bid':'8.3100','ask':'8.3150','vol':'1047.30'},{'date':'2014-01-14','bid':'8.3100','ask':'8.3300','vol':'1301.70'},{'date':'2014-01-15','bid':'8.3200','ask':'8.3300','vol':'1580.70'},{'date':'2014-01-16','bid':'8.3350','ask':'8.3400','vol':'1401.10'},{'date':'2014-01-17','bid':'8.3600','ask':'8.3700','vol':'1247.70'},{'date':'2014-01-20','bid':'8.3700','ask':'8.3900','vol':'469.10'},{'date':'2014-01-21','bid':'8.4000','ask':'8.4150','vol':'2250.90'},{'date':'2014-01-22','bid':'8.4100','ask':'8.4350','vol':'2726.50'},{'date':'2014-01-23','bid':'8.4300','ask':'8.4500','vol':'1860.60'},{'date':'2014-01-24','bid':'8.5000','ask':'8.5400','vol':'2566.50'},{'date':'2014-01-27','bid':'8.6000','ask':'8.6250','vol':'4160.00'},{'date':'2014-01-28','bid':'8.5150','ask':'8.5350','vol':'4737.10'},{'date':'2014-01-29','bid':'8.4850','ask':'8.5000','vol':'2809.70'},{'date':'2014-01-30','bid':'8.6000','ask':'8.6450','vol':'3039.50'},{'date':'2014-01-31','bid':'8.6200','ask':'8.6500','vol':'3388.60'},{'date':'2014-02-03','bid':'8.7000','ask':'8.7400','vol':'4327.30'},{'date':'2014-02-04','bid':'8.8500','ask':'8.9000','vol':'1355.30'},{'date':'2014-02-05','bid':'8.9500','ask':'9.0500','vol':'2624.90'},{'date':'2014-02-06','bid':'8.7800','ask':'8.8800','vol':'1278.40'},{'date':'2014-02-07','bid':'8.5300','ask':'8.5400','vol':'634.50'},{'date':'2014-02-10','bid':'8.4800','ask':'8.5000','vol':'715.70'},{'date':'2014-02-11','bid':'8.6000','ask':'8.6300','vol':'841.70'},{'date':'2014-02-12','bid':'8.7200','ask':'8.7800','vol':'733.80'},{'date':'2014-02-13','bid':'8.7800','ask':'8.8100','vol':'963.40'},{'date':'2014-02-14','bid':'8.8000','ask':'8.8200','vol':'2170.80'},{'date':'2014-02-17','bid':'8.8600','ask':'8.8900','vol':'243.70'},{'date':'2014-02-18','bid':'8.8700','ask':'8.8900','vol':'1310.90'},{'date':'2014-02-19','bid':'8.9000','ask':'9.0000','vol':'667.10'},{'date':'2014-02-20','bid':'9.0100','ask':'9.0700','vol':'842.40'},{'date':'2014-02-21','bid':'9.1500','ask':'9.1800','vol':'648.20'},{'date':'2014-02-24','bid':'9.3200','ask':'9.3600','vol':'1004.20'},{'date':'2014-02-25','bid':'9.6800','ask':'9.7800','vol':'550.00'},{'date':'2014-02-26','bid':'10.3300','ask':'10.5000','vol':'719.00'},{'date':'2014-02-27','bid':'10.8000','ask':'11.1000','vol':'587.90'},{'date':'2014-02-28','bid':'9.6000','ask':'10.5000','vol':'675.10'},{'date':'2014-03-03','bid':'9.9000','ask':'10.5000','vol':'285.60'},{'date':'2014-03-04','bid':'9.1000','ask':'9.5000','vol':'515.00'},{'date':'2014-03-05','bid':'9.3000','ask':'9.4000','vol':'692.50'},{'date':'2014-03-06','bid':'9.2000','ask':'9.2500','vol':'631.50'},{'date':'2014-03-07','bid':'9.1500','ask':'9.2100','vol':'692.90'},{'date':'2014-03-11','bid':'9.2300','ask':'9.2400','vol':'753.80'},{'date':'2014-03-12','bid':'9.3200','ask':'9.4500','vol':'617.10'},{'date':'2014-03-13','bid':'9.7000','ask':'9.8500','vol':'642.00'},{'date':'2014-03-14','bid':'9.7000','ask':'9.9500','vol':'714.90'},{'date':'2014-03-17','bid':'9.9000','ask':'10.1500','vol':'577.70'},{'date':'2014-03-18','bid':'10.0500','ask':'10.1500','vol':'563.60'},{'date':'2014-03-19','bid':'10.1000','ask':'10.2000','vol':'685.50'},{'date':'2014-03-20','bid':'10.3000','ask':'10.4000','vol':'657.00'},{'date':'2014-03-21','bid':'10.8000','ask':'11.0000','vol':'675.50'},{'date':'2014-03-24','bid':'10.6500','ask':'10.8000','vol':'583.40'},{'date':'2014-03-25','bid':'10.9000','ask':'11.0300','vol':'683.70'},{'date':'2014-03-26','bid':'11.1500','ask':'11.2800','vol':'660.00'},{'date':'2014-03-27','bid':'11.1500','ask':'11.3000','vol':'740.70'},{'date':'2014-03-28','bid':'11.2000','ask':'11.3000','vol':'616.60'},{'date':'2014-03-31','bid':'11.4000','ask':'11.5800','vol':'773.90'},{'date':'2014-04-01','bid':'11.3000','ask':'11.5000','vol':'396.30'},{'date':'2014-04-02','bid':'11.3200','ask':'11.4200','vol':'265.80'},{'date':'2014-04-03','bid':'11.4800','ask':'11.5500','vol':'440.30'},{'date':'2014-04-04','bid':'11.5000','ask':'11.6500','vol':'387.80'},{'date':'2014-04-07','bid':'11.6000','ask':'11.8000','vol':'270.60'},{'date':'2014-04-08','bid':'11.6500','ask':'11.8500','vol':'351.10'},{'date':'2014-04-09','bid':'12.1500','ask':'12.4500','vol':'275.40'},{'date':'2014-04-10','bid':'12.9000','ask':'13.2000','vol':'278.90'},{'date':'2014-04-11','bid':'13.0000','ask':'13.3000','vol':'271.20'},{'date':'2014-04-14','bid':'12.7000','ask':'13.0000','vol':'239.30'},{'date':'2014-04-15','bid':'12.0000','ask':'12.2500','vol':'315.70'},{'date':'2014-04-16','bid':'11.2000','ask':'11.4000','vol':'300.30'},{'date':'2014-04-17','bid':'11.1500','ask':'11.4500','vol':'338.20'},{'date':'2014-04-18','bid':'11.3500','ask':'11.8000','vol':'324.40'},{'date':'2014-04-22','bid':'11.5000','ask':'11.6900','vol':'216.00'},{'date':'2014-04-23','bid':'11.5000','ask':'11.5900','vol':'281.20'},{'date':'2014-04-24','bid':'11.4000','ask':'11.5000','vol':'294.50'},{'date':'2014-04-25','bid':'11.4500','ask':'11.6000','vol':'338.60'},{'date':'2014-04-28','bid':'11.6000','ask':'11.8500','vol':'211.40'},{'date':'2014-04-29','bid':'11.4500','ask':'11.7500','vol':'257.00'},{'date':'2014-04-30','bid':'11.4174','ask':'11.6084','vol':'345.40'},{'date':'2014-05-05','bid':'11.6500','ask':'11.8500','vol':'340.40'},{'date':'2014-05-06','bid':'11.9000','ask':'12.0000','vol':'233.80'},{'date':'2014-05-07','bid':'11.8000','ask':'11.9500','vol':'301.00'},{'date':'2014-05-08','bid':'11.7000','ask':'11.8500','vol':'264.40'},{'date':'2014-05-12','bid':'11.7000','ask':'11.8000','vol':'232.20'},{'date':'2014-05-13','bid':'11.7500','ask':'11.8500','vol':'233.50'},{'date':'2014-05-14','bid':'11.8000','ask':'12.0000','vol':'220.80'},{'date':'2014-05-15','bid':'11.9000','ask':'11.9800','vol':'263.80'},{'date':'2014-05-16','bid':'11.9000','ask':'12.0000','vol':'239.70'},{'date':'2014-05-19','bid':'11.9000','ask':'12.0500','vol':'203.70'},{'date':'2014-05-20','bid':'11.9300','ask':'12.0500','vol':'363.60'},{'date':'2014-05-21','bid':'11.9000','ask':'11.9300','vol':'255.60'},{'date':'2014-05-22','bid':'11.9200','ask':'12.0000','vol':'211.90'},{'date':'2014-05-23','bid':'11.9900','ask':'12.0500','vol':'211.70'},{'date':'2014-05-26','bid':'11.8600','ask':'11.9200','vol':'113.40'},{'date':'2014-05-27','bid':'11.8900','ask':'11.9600','vol':'387.90'},{'date':'2014-05-28','bid':'11.9000','ask':'11.9400','vol':'271.80'},{'date':'2014-05-29','bid':'11.8000','ask':'11.8500','vol':'317.20'},{'date':'2014-05-30','bid':'11.8300','ask':'11.8800','vol':'1426.90'},{'date':'2014-06-02','bid':'11.8500','ask':'11.9500','vol':'236.40'},{'date':'2014-06-03','bid':'11.9910','ask':'12.0185','vol':'233.50'},{'date':'2014-06-04','bid':'11.9300','ask':'12.0000','vol':'211.70'},{'date':'2014-06-05','bid':'11.8500','ask':'11.9000','vol':'265.20'},{'date':'2014-06-06','bid':'11.8500','ask':'11.9000','vol':'326.50'},{'date':'2014-06-10','bid':'11.5500','ask':'11.6700','vol':'248.30'},{'date':'2014-06-11','bid':'11.6500','ask':'11.7500','vol':'327.00'},{'date':'2014-06-12','bid':'11.7000','ask':'11.8300','vol':'235.10'},{'date':'2014-06-13','bid':'11.7000','ask':'11.9000','vol':'233.90'},{'date':'2014-06-16','bid':'11.8500','ask':'11.9200','vol':'306.00'},{'date':'2014-06-17','bid':'11.9200','ask':'11.9700','vol':'218.00'},{'date':'2014-06-18','bid':'11.9500','ask':'12.0000','vol':'229.40'},{'date':'2014-06-19','bid':'11.8600','ask':'11.9000','vol':'266.30'},{'date':'2014-06-20','bid':'11.8900','ask':'11.9800','vol':'308.10'},{'date':'2014-06-23','bid':'11.9200','ask':'11.9600','vol':'241.10'},{'date':'2014-06-24','bid':'11.9000','ask':'11.9500','vol':'237.00'},{'date':'2014-06-25','bid':'11.8800','ask':'11.9200','vol':'267.20'},{'date':'2014-06-26','bid':'11.8500','ask':'11.9100','vol':'355.30'},{'date':'2014-06-27','bid':'11.7500','ask':'11.8300','vol':'349.10'},{'date':'2014-07-01','bid':'11.8500','ask':'11.9100','vol':'269.90'},{'date':'2014-07-02','bid':'11.8300','ask':'11.8800','vol':'291.60'},{'date':'2014-07-03','bid':'11.8000','ask':'11.8700','vol':'325.50'},{'date':'2014-07-04','bid':'11.7800','ask':'11.8000','vol':'141.20'},{'date':'2014-07-07','bid':'11.7200','ask':'11.7800','vol':'304.00'},{'date':'2014-07-08','bid':'11.6200','ask':'11.6900','vol':'327.70'},{'date':'2014-07-09','bid':'11.7200','ask':'11.8000','vol':'269.70'},{'date':'2014-07-10','bid':'11.6500','ask':'11.7500','vol':'330.40'},{'date':'2014-07-11','bid':'11.6600','ask':'11.7200','vol':'253.20'},{'date':'2014-07-14','bid':'11.6900','ask':'11.7300','vol':'289.00'},{'date':'2014-07-15','bid':'11.6800','ask':'11.7400','vol':'356.80'},{'date':'2014-07-16','bid':'11.6800','ask':'11.7200','vol':'228.70'},{'date':'2014-07-17','bid':'11.6600','ask':'11.7200','vol':'250.50'},{'date':'2014-07-18','bid':'11.6700','ask':'11.7200','vol':'287.00'},{'date':'2014-07-21','bid':'11.6300','ask':'11.6900','vol':'202.10'},{'date':'2014-07-22','bid':'11.6500','ask':'11.6800','vol':'221.00'},{'date':'2014-07-23','bid':'11.6800','ask':'11.7000','vol':'310.00'},{'date':'2014-07-24','bid':'11.6800','ask':'11.7800','vol':'228.10'},{'date':'2014-07-25','bid':'11.9000','ask':'11.9500','vol':'212.20'},{'date':'2014-07-28','bid':'12.1000','ask':'12.2000','vol':'229.00'},{'date':'2014-07-29','bid':'12.1000','ask':'12.2000','vol':'230.60'},{'date':'2014-07-30','bid':'12.1900','ask':'12.2900','vol':'248.90'},{'date':'2014-07-31','bid':'12.1500','ask':'12.3000','vol':'250.40'},{'date':'2014-08-01','bid':'12.3200','ask':'12.4000','vol':'340.40'},{'date':'2014-08-04','bid':'12.4000','ask':'12.5000','vol':'198.30'},{'date':'2014-08-05','bid':'12.3500','ask':'12.5000','vol':'285.90'},{'date':'2014-08-06','bid':'12.3800','ask':'12.5000','vol':'230.50'},{'date':'2014-08-07','bid':'12.5000','ask':'12.6000','vol':'254.60'},{'date':'2014-08-08','bid':'12.6200','ask':'12.7000','vol':'302.50'},{'date':'2014-08-11','bid':'12.9200','ask':'13.2000','vol':'343.50'},{'date':'2014-08-12','bid':'13.4500','ask':'13.6000','vol':'236.40'},{'date':'2014-08-13','bid':'13.0000','ask':'13.5000','vol':'299.20'},{'date':'2014-08-14','bid':'13.0000','ask':'13.1500','vol':'295.70'},{'date':'2014-08-15','bid':'13.0000','ask':'13.1500','vol':'435.70'},{'date':'2014-08-18','bid':'13.1000','ask':'13.2000','vol':'222.90'},{'date':'2014-08-19','bid':'13.1000','ask':'13.2000','vol':'394.50'},{'date':'2014-08-20','bid':'13.3000','ask':'13.4000','vol':'296.70'},{'date':'2014-08-21','bid':'13.3000','ask':'13.5000','vol':'378.60'},{'date':'2014-08-22','bid':'13.6000','ask':'13.8000','vol':'217.50'},{'date':'2014-08-26','bid':'13.9500','ask':'14.3000','vol':'240.70'},{'date':'2014-08-27','bid':'13.0000','ask':'14.0000','vol':'309.30'},{'date':'2014-08-28','bid':'13.8000','ask':'13.9500','vol':'421.40'},{'date':'2014-08-29','bid':'13.8000','ask':'14.4000','vol':'285.10'},{'date':'2014-09-01','bid':'13.0500','ask':'13.5000','vol':'239.50'},{'date':'2014-09-02','bid':'12.6000','ask':'12.9500','vol':'184.60'},{'date':'2014-09-03','bid':'12.4000','ask':'12.6000','vol':'124.70'},{'date':'2014-09-04','bid':'12.8500','ask':'13.1000','vol':'282.50'},{'date':'2014-09-05','bid':'13.0000','ask':'13.3000','vol':'215.20'},{'date':'2014-09-08','bid':'13.0833','ask':'13.3500','vol':'320.40'},{'date':'2014-09-09','bid':'12.9000','ask':'13.2000','vol':'258.40'},{'date':'2014-09-10','bid':'13.1000','ask':'13.4000','vol':'234.10'},{'date':'2014-09-11','bid':'13.3000','ask':'13.5000','vol':'168.60'},{'date':'2014-09-12','bid':'13.5000','ask':'14.0000','vol':'187.40'},{'date':'2014-09-15','bid':'13.7000','ask':'14.0000','vol':'200.90'},{'date':'2014-09-16','bid':'14.0000','ask':'14.3000','vol':'193.90'},{'date':'2014-09-17','bid':'14.0000','ask':'14.2000','vol':'260.20'},{'date':'2014-09-18','bid':'14.1000','ask':'14.3500','vol':'134.60'},{'date':'2014-09-19','bid':'14.2000','ask':'14.6000','vol':'228.00'},{'date':'2014-09-22','bid':'14.3000','ask':'14.6000','vol':'213.80'},{'date':'2014-09-23','bid':'14.5000','ask':'14.9800','vol':'295.20'},{'date':'2014-09-24','bid':'12.9500','ask':'12.9500','vol':'269.00'},{'date':'2014-09-25','bid':'12.9900','ask':'13.4000','vol':'336.90'},{'date':'2014-09-26','bid':'12.9600','ask':'13.3900','vol':'150.70'},{'date':'2014-09-26','bid':'12.9500','ask':'13.3900','vol':'150.70'},{'date':'2014-09-29','bid':'12.9500','ask':'13.3900','vol':'184.30'},{'date':'2014-09-30','bid':'12.9500','ask':'13.3900','vol':'149.70'},{'date':'2014-10-01','bid':'12.9500','ask':'13.4000','vol':'1767.80'},{'date':'2014-10-02','bid':'12.9500','ask':'13.3500','vol':'368.30'},{'date':'2014-10-03','bid':'12.9500','ask':'13.1400','vol':'173.70'},{'date':'2014-10-06','bid':'12.9500','ask':'13.1500','vol':'134.30'},{'date':'2014-10-07','bid':'12.9500','ask':'13.1100','vol':'168.30'},{'date':'2014-10-08','bid':'12.9800','ask':'13.1800','vol':'145.60'},{'date':'2014-10-09','bid':'12.9800','ask':'13.1800','vol':'312.90'},{'date':'2014-10-10','bid':'12.9700','ask':'13.1200','vol':'340.60'},{'date':'2014-10-13','bid':'12.9700','ask':'13.1300','vol':'94.20'},{'date':'2014-10-14','bid':'12.9900','ask':'13.1800','vol':'146.30'},{'date':'2014-10-15','bid':'12.9500','ask':'13.1500','vol':'160.70'},{'date':'2014-10-16','bid':'12.9800','ask':'13.1000','vol':'269.00'},{'date':'2014-10-17','bid':'12.9600','ask':'13.1000','vol':'316.80'},{'date':'2014-10-20','bid':'12.9600','ask':'13.1100','vol':'484.30'},{'date':'2014-10-21','bid':'12.9600','ask':'13.1100','vol':'208.80'},{'date':'2014-10-22','bid':'12.9700','ask':'13.1200','vol':'185.40'},{'date':'2014-10-23','bid':'12.9600','ask':'13.1100','vol':'262.50'},{'date':'2014-10-24','bid':'12.9500','ask':'13.1100','vol':'157.70'},{'date':'2014-10-27','bid':'12.9800','ask':'13.1300','vol':'444.00'},{'date':'2014-10-28','bid':'13.0000','ask':'13.5000','vol':'189.10'},{'date':'2014-10-29','bid':'12.9800','ask':'13.5000','vol':'183.20'},{'date':'2014-10-30','bid':'12.9700','ask':'13.4500','vol':'256.70'},{'date':'2014-10-31','bid':'12.9900','ask':'13.4800','vol':'183.80'},{'date':'2014-11-03','bid':'12.9600','ask':'13.4600','vol':'392.00'},{'date':'2014-11-04','bid':'12.9600','ask':'13.4600','vol':'113.60'},{'date':'2014-11-05','bid':'13.6000','ask':'14.0000','vol':'178.20'},{'date':'2014-11-06','bid':'14.1500','ask':'14.6000','vol':'176.10'}];

var parseData = function(courses){
	var parsedData = {};
	_.each(courses, function(c){
		var date = new Date(c.date),
			month = date.getMonth(),
			day = date.getDate();

		if (!parsedData[month]) {
			parsedData[month] = {};
		}
		parsedData[month][day] = Number(c.bid);
	});
	return parsedData;
};
var decDay = function(day, month){
	day--;
	if (!day){
		day = 31;
		month--;
	}
	return [day, month];
};

var incDay = function(day, month){
	day++;
	if(day > 31){
		day = 1;
		month++;
	}
	return [day, month];
};

var getDayCourse = function(day, month){
	var m = parsedData[month];
	if (!m) { return false; }

	var course = m[day];
	if (!course){
		course = getDayCourse.apply(this, decDay(day, month));
	}
	return course;
};

var getDayCourses = function(day){
	var result = [];
	for (var i = chartOptions.startMonth; i < (chartOptions.endMonth + 1); i++){
		var course = getDayCourse(day, i);
		if (course) {
			result.push(course);
		}
	}
	return result;
};

var fillCoursesByDay = function(){
	var dayCourses = [];
	for (var i = 1; i<32; i++){
		dayCourses.push({day:i, values: getDayCourses(i)});
	}
	return dayCourses;
};

var getBounds = function(courses){
	var bounds = {
			max: {
				averageValue: courses[0].averageValue
			},
			min: {
				averageValue: courses[0].averageValue
			}
		};

	_.each(courses, function(a, i){
		if (bounds.max.averageValue < a.averageValue){
			bounds.max = a;
		}
		if (bounds.min.averageValue > a.averageValue){
			bounds.min = a;
		}
	});
	return bounds;
};

var redrawChart = function(data){
	var bounds = getBounds(data);

	var heightScale = d3.scale.linear()
						.domain([bounds.min.averageValue * 0.99, bounds.max.averageValue])
						.range([0, chartOptions.height]);

	var colorScale = d3.scale.linear()
						.domain([bounds.min.averageValue * 0.99, bounds.max.averageValue*0.9999, bounds.max.averageValue])
						.range(['red', 'green', 'limegreen']);

	var bars = canvas.selectAll('.bar')
		.data(data);

		bars.select('rect')
			.attr({
					width: chartOptions.barWidth,
					height: function(d) { return heightScale(d.averageValue);},
					x: function(d, i) { return (chartOptions.barWidth + chartOptions.barsSpace) * i;},
					y: function(d) { return chartOptions.height - heightScale(d.averageValue); },
					fill: function(d) { return colorScale(d.averageValue);}
				});

		bars.select('.value')
			.attr({
				y: function(d){return chartOptions.height - heightScale(d.averageValue) + 10;},
			})
			.text(function(d){ return d.averageValue.toFixed(2); });

		bars.select('.day').text(function(d){ return d.day; });
};

var calculateData = function(){
	var averageCoursesByDay = _.map(fillCoursesByDay(), function(c){
		var sum = _.reduce(c.values, function(sum, num){
			return sum + num;
		});
		c.averageValue = (sum / c.values.length) || 0;
		return c;
	});
	return averageCoursesByDay;
};

var parsedData = parseData(courses);

var averageCoursesByDay = calculateData();

var canvas = d3.select('.chart')
			.append('svg')
			.attr({
				width: chartOptions.width,
				height: chartOptions.height
			})
			.append('g')
			.attr('transform','translate(10,10)');

var bars = canvas.selectAll('.bar')
			.data(averageCoursesByDay)
			.enter()
			.append('g')
			.attr('class','bar');

	bars.append('rect');

	bars.append('text')
		.attr({
			class: 'value',
			x: function(d, i) { return (chartOptions.barWidth + chartOptions.barsSpace) * i + chartOptions.barWidth / 2;},
			'text-anchor': 'middle',
			'font-size': '0.6em',
			'fill': 'white'
		});

	bars.append('text')
		.attr({
			class: 'day',
			x: function(d, i) { return (chartOptions.barWidth + chartOptions.barsSpace) * i + chartOptions.barWidth / 2;},
			y: function(d){return chartOptions.height - 20;},
			'text-anchor': 'middle',
			'fill': 'white'
		});
	
redrawChart(averageCoursesByDay);

$(function(){
	$('.monthSelector').change(function(){
		var $this = $(this);
		chartOptions[$this.data('field')] = Number($this.val());
		redrawChart(calculateData());
	});
});			

})(window._, window.d3);
